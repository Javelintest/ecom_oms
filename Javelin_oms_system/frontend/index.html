<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Javelin Suite - E-commerce Management Software</title>
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="static/css/style.css" />
    <script src="static/js/auth-check.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      :root {
        --portal-bg: #020617;
        --accent-primary: #3b82f6;
        --accent-secondary: #8b5cf6;
        --glass-bg: rgba(30, 41, 59, 0.4);
        --glass-border: rgba(255, 255, 255, 0.08);
        --text-main: #f1f5f9;
        --text-dim: #94a3b8;
        --mesh-opacity: 0.5;
      }

      /* Light Mode Variables */
      [data-theme="light"] {
        --portal-bg: #f8fafc;
        --accent-primary: #2563eb;
        --accent-secondary: #7c3aed;
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(0, 0, 0, 0.05);
        --text-main: #0f172a;
        --text-dim: #475569;
        --mesh-opacity: 0.3;
      }

      body {
        background-color: var(--portal-bg);
        background-image: radial-gradient(
            at 0% 0%,
            rgba(59, 130, 246, 0.15) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 100%,
            rgba(139, 92, 246, 0.15) 0px,
            transparent 50%
          );
        color: var(--text-main);
        font-family: "Outfit", sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        transition: background-color 0.4s ease, color 0.4s ease;
        overflow-x: hidden;
      }

      /* Animated Mesh Background */
      .bg-mesh {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        opacity: var(--mesh-opacity);
        transition: opacity 0.4s ease;
        overflow: hidden;
      }

      /* Tech Grid Pattern */
      .bg-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 200%;
        height: 200%;
        background-image: linear-gradient(
            rgba(255, 255, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 60px 60px;
        transform: perspective(500px) rotateX(20deg) translateY(-100px)
          translateZ(-200px);
        animation: gridMove 60s linear infinite;
      }

      [data-theme="light"] .bg-grid {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
      }

      @keyframes gridMove {
        0% {
          transform: perspective(500px) rotateX(20deg) translateY(0)
            translateZ(-200px);
        }
        100% {
          transform: perspective(500px) rotateX(20deg) translateY(60px)
            translateZ(-200px);
        }
      }

      /* Floating Orbs */
      .mesh-ball {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.6;
        animation: floatOrb 20s infinite ease-in-out alternate;
      }

      @keyframes floatOrb {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(30px, -50px);
        }
      }

      /* Floating Particles */
      .particle {
        position: absolute;
        background: var(--accent-primary);
        border-radius: 50%;
        opacity: 0.3;
        animation: rise 15s infinite linear;
      }

      @keyframes rise {
        0% {
          transform: translateY(110vh) scale(0);
          opacity: 0;
        }
        20% {
          opacity: 0.4;
        }
        50% {
          opacity: 0.4;
        }
        80% {
          opacity: 0;
        }
        100% {
          transform: translateY(-10vh) scale(1);
          opacity: 0;
        }
      }

      .portal-container {
        width: 100%;
        max-width: 1280px;
        padding: 2rem;
        position: relative;
        z-index: 1;
      }

      .portal-header {
        text-align: center;
        margin-bottom: 4rem;
        animation: fadeInDown 1s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      .portal-logo {
        font-size: clamp(2.5rem, 5vw, 4rem);
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Logo Gradient for Light Mode */
      [data-theme="light"] .portal-logo {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .portal-subtitle {
        font-family: "Inter", sans-serif;
        color: var(--text-dim);
        font-size: 1.1rem;
        font-weight: 400;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .portal-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
      }

      /* Premium Glass Card */
      .service-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 2rem;
        padding: 2.5rem;
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
        overflow: hidden;
        text-decoration: none;
        color: var(--text-main); /* Dynamic Text Color */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .service-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.03),
          transparent
        );
        transition: 0.5s;
      }

      .service-card:hover {
        transform: translateY(-8px) scale(1.02);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5),
          0 0 20px rgba(59, 130, 246, 0.1);
      }

      .service-card:hover::before {
        left: 100%;
      }

      /* Hero Card (Wide) */
      .card-hero {
        grid-column: span 8;
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.95),
          rgba(15, 23, 42, 0.98)
        ); /* Force Dark background */
        border-left: 4px solid var(--accent-primary);
        color: #fff; /* Force White text */
      }

      /* Force light text description in Hero Card even in light mode */
      .card-hero .service-desc {
        color: #94a3b8 !important;
      }

      .card-standard {
        grid-column: span 4;
      }

      .card-accent-mango {
        border-bottom: 4px solid #ffca28;
      }
      .card-accent-reports {
        border-bottom: 4px solid #10b981;
      }
      .card-accent-sync {
        border-bottom: 4px solid #ec4899;
      }

      .service-icon {
        width: 60px;
        height: 60px;
        background: rgba(
          255,
          255,
          255,
          0.05
        ); /* Works for dark. Light mode needs adjustment? */
        border-radius: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 2rem;
        transition: transform 0.3s ease;
      }

      /* Darker icon bg for light mode */
      [data-theme="light"] .service-icon {
        background: rgba(0, 0, 0, 0.05);
      }
      [data-theme="light"] .card-hero .service-icon {
        background: rgba(255, 255, 255, 0.1); /* Keep light for Hero */
      }

      .service-card:hover .service-icon {
        transform: scale(1.1) rotate(5deg);
      }

      .service-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: inherit; /* Inherit from card color */
      }

      .service-desc {
        font-family: "Inter", sans-serif;
        color: var(--text-dim);
        line-height: 1.6;
        margin-bottom: 2rem;
        font-size: 0.95rem;
      }

      .service-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        font-size: 0.9rem;
        color: #fff;
        text-decoration: none;
        margin-top: auto;
        transition: gap 0.3s ease;
      }

      .service-card:hover .service-btn {
        gap: 1.25rem;
        color: var(--accent-primary);
      }

      .hero-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .btn-premium {
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 1rem;
        color: white;
        font-weight: 600;
        box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        transition: all 0.3s;
      }

      .btn-premium:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 20px -5px rgba(59, 130, 246, 0.4);
        color: white;
      }

      /* Theme & Profile Styles */
      .portal-top-bar {
        position: absolute;
        top: 2rem;
        right: 2rem;
        display: flex;
        gap: 1rem;
        align-items: center;
        z-index: 100;
      }

      .action-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        color: var(--text-main);
        font-size: 1.2rem;
      }

      .action-circle:hover {
        transform: scale(1.1);
        border-color: var(--accent-primary);
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
      }

      .dropdown-menu-premium {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 1.25rem;
        padding: 0.75rem;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        margin-top: 10px !important;
        min-width: 200px;
      }

      .dropdown-item-premium {
        border-radius: 0.75rem;
        padding: 0.6rem 1rem;
        color: var(--text-main);
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .dropdown-item-premium:hover {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-primary);
      }

      .dropdown-item-premium i {
        font-size: 1.1rem;
      }

      .theme-icon-dark {
        display: none;
      }
      [data-theme="light"] .theme-icon-dark {
        display: block;
      }
      [data-theme="light"] .theme-icon-light {
        display: none;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mobile Adjustments */
      @media (max-width: 992px) {
        .card-hero,
        .card-standard {
          grid-column: span 12;
        }
        .portal-container {
          padding: 1rem;
        }
        .service-card {
          padding: 2rem;
        }
      }

      /* Entrance Animation Stagger */
      .service-card {
        animation: cardEntrance 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) backwards;
      }
      .service-card:nth-child(1) {
        animation-delay: 0.2s;
      }
      .service-card:nth-child(2) {
        animation-delay: 0.3s;
      }
      .service-card:nth-child(3) {
        animation-delay: 0.4s;
      }
      .service-card:nth-child(4) {
        animation-delay: 0.5s;
      }

      @keyframes cardEntrance {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(30px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="bg-mesh">
      <div class="bg-grid"></div>
      <div
        class="mesh-ball"
        style="
          width: 500px;
          height: 500px;
          background: rgba(59, 130, 246, 0.2);
          left: -10%;
          top: -10%;
        "
      ></div>
      <div
        class="mesh-ball"
        style="
          width: 400px;
          height: 400px;
          background: rgba(139, 92, 246, 0.2);
          right: -5%;
          bottom: -5%;
          animation-delay: -5s;
        "
      ></div>
      <div
        class="mesh-ball"
        style="
          width: 300px;
          height: 300px;
          background: rgba(6, 182, 212, 0.15);
          left: 30%;
          bottom: 20%;
          animation-delay: -10s;
        "
      ></div>
      <!-- Particles Container -->
      <div id="particles-container"></div>
    </div>

    <div class="portal-container">
      <!-- Top Bar with Theme Toggle and Profile -->
      <div class="portal-top-bar">
        <!-- Active Company Badge -->
        <div class="d-none d-md-flex align-items-center me-auto">
          <div
            class="px-3 py-2 rounded-pill bg-light border shadow-sm d-flex align-items-center gap-2"
            id="portal-company-badge"
            style="opacity: 0; transition: opacity 0.5s"
          >
            <div
              class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
              style="
                width: 24px;
                height: 24px;
                font-size: 0.8rem;
                font-weight: bold;
              "
            >
              <i class="bi bi-building"></i>
            </div>
            <span class="fw-bold text-dark small" id="portal-company-name"
              >Loading...</span
            >
          </div>
        </div>

        <!-- Theme Toggle -->
        <div class="action-circle" id="theme-toggle" title="Toggle Theme">
          <i class="bi bi-moon-stars-fill theme-icon-light"></i>
          <i class="bi bi-sun-fill theme-icon-dark"></i>
        </div>

        <!-- Profile Dropdown -->
        <div class="dropdown">
          <div
            class="action-circle"
            id="profileDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <i class="bi bi-person-circle"></i>
          </div>
          <ul
            class="dropdown-menu dropdown-menu-end dropdown-menu-premium"
            aria-labelledby="profileDropdown"
          >
            <li><h6 class="dropdown-header text-dim">User Account</h6></li>
            <li>
              <a
                class="dropdown-item dropdown-item-premium"
                href="#"
                onclick="openProfileModal()"
                ><i class="bi bi-person"></i> My Profile</a
              >
            </li>
            <li>
              <a
                class="dropdown-item dropdown-item-premium"
                href="#"
                onclick="openOrgManager()"
                ><i class="bi bi-building"></i> My Organizations</a
              >
            </li>
            <li>
              <a
                class="dropdown-item dropdown-item-premium"
                href="#"
                onclick="openSettingsModal()"
                ><i class="bi bi-gear"></i> Settings</a
              >
            </li>
            <li><hr class="dropdown-divider opacity-10" /></li>
            <li>
              <a
                class="dropdown-item dropdown-item-premium text-danger"
                href="#"
                id="portal-logout"
                ><i class="bi bi-box-arrow-right"></i> Log Out</a
              >
            </li>
          </ul>
        </div>
      </div>

      <header class="portal-header">
        <h1 class="portal-logo">Javelin E-commerce Suite</h1>
        <p class="portal-subtitle">Advanced Multi-Marketplace Ecosystem</p>
      </header>

      <div class="portal-grid">
        <!-- OMS Card (Hero) -->
        <a href="apps/oms/oms.html" class="service-card card-hero">
          <div>
            <div class="service-icon">
              <i class="bi bi-cpu-fill text-primary"></i>
            </div>
            <div class="row align-items-center">
              <div class="col-lg-8">
                <h3 class="service-title">Order Management System</h3>
                <p class="service-desc">
                  The central nervous system of your business. Unified order
                  processing from Amazon, Flipkart, Meesho, and Myntra with
                  intelligent routing and inventory preservation.
                </p>
                <div class="hero-actions">
                  <span class="btn-premium">Launch Control Center</span>
                </div>
              </div>
              <div class="col-lg-4 d-none d-lg-block text-center">
                <i
                  class="bi bi-cart-check"
                  style="
                    font-size: 8rem;
                    opacity: 0.1;
                    color: var(--accent-primary);
                  "
                ></i>
              </div>
            </div>
          </div>
        </a>

        <!-- Mango Platform Card -->
        <a
          href="apps/mango/mango.html"
          class="service-card card-standard card-accent-mango"
        >
          <div class="service-icon">
            <i class="bi bi-pentagon-fill" style="color: #ffca28"></i>
          </div>
          <h3 class="service-title">Mango Operations</h3>
          <p class="service-desc">
            Advanced Order ID tracking, automated payment reconciliation, and
            granular order flow management.
          </p>
          <div class="service-btn">
            Open Dashboard <i class="bi bi-arrow-right"></i>
          </div>
        </a>

        <!-- Reports Card -->
        <a
          href="apps/oms/reports.html"
          class="service-card card-standard card-accent-reports"
        >
          <div class="service-icon">
            <i class="bi bi-bar-chart-line-fill" style="color: #10b981"></i>
          </div>
          <h3 class="service-title">Business Intelligence</h3>
          <p class="service-desc">
            Deep-dive analytics and cross-platform performance auditing with
            automated PDF exports.
          </p>
          <div class="service-btn">
            View Insights <i class="bi bi-arrow-right"></i>
          </div>
        </a>

        <!-- Sync Connections Card -->
        <a
          href="apps/oms/connections.html"
          class="service-card card-standard card-accent-sync"
        >
          <div class="service-icon">
            <i class="bi bi-hdd-network-fill" style="color: #ec4899"></i>
          </div>
          <h3 class="service-title">Platform Sync</h3>
          <p class="service-desc">
            Manage API credentials, security tokens, and live synchronization
            health across all marketplaces.
          </p>
          <div class="service-btn">
            Settings & Bridge <i class="bi bi-arrow-right"></i>
          </div>
        </a>

        <!-- Organization Card -->
        <div
          onclick="openOrgManager()"
          class="service-card card-standard"
          style="cursor: pointer; --hover-border: #6366f1"
        >
          <div class="service-icon">
            <i class="bi bi-building-fill-gear" style="color: #6366f1"></i>
          </div>
          <h3 class="service-title">My Organizations</h3>
          <p class="service-desc">
            Switch between different company profiles, create new organizations,
            and manage access.
          </p>
          <div class="service-btn">
            Manage Organizations <i class="bi bi-arrow-right"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Company Setup Modal (Professional Light Theme) -->
    <div
      class="modal fade"
      id="setupCompanyModal"
      tabindex="-1"
      aria-labelledby="setupCompanyLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div
          class="modal-content border-0 shadow-lg"
          style="border-radius: 12px; overflow: hidden"
        >
          <div class="modal-header bg-white border-bottom py-3 px-4">
            <h5 class="modal-title fw-bold text-dark" id="setupCompanyLabel">
              <i class="bi bi-building-fill-gear text-primary me-2"></i>Setup
              Organization Profile
            </h5>
            <!-- Close button logic handles separately if needed but usually hidden for first setup -->
          </div>
          <div class="modal-body bg-light p-0">
            <form id="companySetupForm" class="p-4">
              <p class="text-muted mb-4 small">
                Please provide your organization details to configure your
                workspace.
              </p>

              <div class="row g-4">
                <!-- Left Column: Identity -->
                <div class="col-md-6">
                  <h6 class="text-uppercase text-secondary small fw-bold mb-3">
                    Identity & Contact
                  </h6>

                  <div class="mb-3">
                    <label class="form-label small fw-bold text-dark"
                      >Organization Name
                      <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="cmp_name"
                      required
                      placeholder="e.g. Acme Industries Ltd."
                    />
                  </div>

                  <div class="mb-3">
                    <label class="form-label small fw-bold text-dark"
                      >Official Email</label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="cmp_email"
                      placeholder="contact@acme.com"
                    />
                  </div>

                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >Phone</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="cmp_phone"
                        placeholder="+91..."
                      />
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >Website</label
                      >
                      <input
                        type="url"
                        class="form-control"
                        id="cmp_website"
                        placeholder="https://"
                      />
                    </div>
                  </div>

                  <h6
                    class="text-uppercase text-secondary small fw-bold mb-3 mt-4"
                  >
                    Settings
                  </h6>
                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >Currency</label
                      >
                      <select class="form-select" id="cmp_currency">
                        <option value="INR" selected>INR (₹)</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                      </select>
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >Timezone</label
                      >
                      <select class="form-select" id="cmp_timezone">
                        <option value="Asia/Kolkata" selected>
                          IST (Asia/Kolkata)
                        </option>
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">EST (New York)</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Right Column: Address -->
                <div class="col-md-6 border-start-md ps-md-4">
                  <h6 class="text-uppercase text-secondary small fw-bold mb-3">
                    Registered Address
                  </h6>

                  <div class="mb-3">
                    <label class="form-label small fw-bold text-dark"
                      >Address Line 1</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="cmp_address"
                      placeholder="Street, Building, Flat"
                    />
                  </div>

                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >City</label
                      >
                      <input type="text" class="form-control" id="cmp_city" />
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >State</label
                      >
                      <input type="text" class="form-control" id="cmp_state" />
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >ZIP/Postal Code</label
                      >
                      <input type="text" class="form-control" id="cmp_zip" />
                    </div>
                    <div class="col-6 mb-3">
                      <label class="form-label small fw-bold text-dark"
                        >Country</label
                      >
                      <select class="form-select" id="cmp_country">
                        <option value="India" selected>India</option>
                        <option value="USA">USA</option>
                        <option value="UK">UK</option>
                        <option value="UAE">UAE</option>
                      </select>
                    </div>
                  </div>

                  <h6
                    class="text-uppercase text-secondary small fw-bold mb-3 mt-4"
                  >
                    Legal
                  </h6>
                  <div class="mb-3">
                    <label class="form-label small fw-bold text-dark"
                      >Tax ID / GSTIN</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="cmp_tax"
                      placeholder="e.g. 29ABCDE1234F1Z5"
                    />
                  </div>
                </div>
              </div>

              <div
                class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top"
              >
                <button
                  type="button"
                  class="btn btn-light"
                  data-bs-dismiss="modal"
                  id="btn-cancel-setup"
                  style="display: none"
                >
                  Cancel
                </button>
                <!-- Only show if optional -->
                <button
                  type="submit"
                  class="btn btn-primary px-4 fw-bold shadow-sm"
                >
                  Save Organization
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Org Manager Modal (Professional Light Theme) -->
    <div
      class="modal fade"
      id="orgManagerModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div
          class="modal-content border-0 shadow-lg"
          style="border-radius: 12px; overflow: hidden"
        >
          <div class="modal-header bg-white border-bottom py-3 px-4">
            <h5 class="modal-title fw-bold text-dark">
              <i class="bi bi-building me-2 text-primary"></i>My Organizations
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body bg-light p-4">
            <div id="org-list" class="vstack gap-3 mb-4">
              <!-- Content loaded via JS -->
              <div class="text-center text-muted p-4">
                <div
                  class="spinner-border spinner-border-sm text-primary"
                ></div>
                <div class="mt-2 small">Loading organizations...</div>
              </div>
            </div>

            <button
              class="btn btn-outline-primary w-100 py-2 fw-bold"
              onclick="showCreateCompanyModal()"
              style="border-style: dashed; border-width: 2px"
            >
              <i class="bi bi-plus-lg me-1"></i> Create New Organization
            </button>
            <p
              class="text-center text-muted mt-3 mb-0"
              style="font-size: 0.8rem"
            >
              Select an organization to switch your active workspace context.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Modal (Professional Light Theme) -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div
          class="modal-content border-0 shadow-lg"
          style="border-radius: 12px; overflow: hidden"
        >
          <div class="modal-header bg-white border-bottom py-3 px-4">
            <h5 class="modal-title fw-bold text-dark">
              <i class="bi bi-person-circle me-2 text-primary"></i>User Profile
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body bg-light p-4">
            <ul
              class="nav nav-pills mb-4 nav-fill bg-white p-1 rounded border"
              id="profileTab"
              role="tablist"
            >
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active fw-bold"
                  id="user-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#user-details"
                  type="button"
                  role="tab"
                >
                  <i class="bi bi-person me-2"></i>User Details
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link fw-bold"
                  id="company-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#company-details"
                  type="button"
                  role="tab"
                >
                  <i class="bi bi-building me-2"></i>Company Details
                </button>
              </li>
            </ul>

            <div class="tab-content" id="profileTabContent">
              <!-- User Details -->
              <div
                class="tab-pane fade show active"
                id="user-details"
                role="tabpanel"
              >
                <div class="card border-0 shadow-sm">
                  <div class="card-body p-4">
                    <div class="row mb-3">
                      <div class="col-md-3 text-muted">Full Name</div>
                      <div class="col-md-9 fw-bold text-dark" id="prof-name">
                        -
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-3 text-muted">Email Address</div>
                      <div class="col-md-9 fw-bold text-dark" id="prof-email">
                        -
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-3 text-muted">User ID</div>
                      <div
                        class="col-md-9 font-monospace text-secondary"
                        id="prof-id"
                      >
                        -
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Company Details -->
              <div class="tab-pane fade" id="company-details" role="tabpanel">
                <div class="card border-0 shadow-sm">
                  <div class="card-body p-4">
                    <div id="prof-company-content">
                      <div class="row mb-3">
                        <div class="col-md-3 text-muted">Organization</div>
                        <div
                          class="col-md-9 fw-bold text-primary"
                          id="prof-comp-name"
                        >
                          -
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-3 text-muted">Address</div>
                        <div class="col-md-9 text-dark" id="prof-comp-address">
                          -
                        </div>
                      </div>
                      <div class="row mb-3">
                        <div class="col-md-3 text-muted">Contact</div>
                        <div class="col-md-9 text-dark">
                          <div id="prof-comp-email"></div>
                          <div id="prof-comp-phone"></div>
                          <div id="prof-comp-website"></div>
                        </div>
                      </div>
                      <hr />
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <small
                            class="text-uppercase text-muted fw-bold"
                            style="font-size: 0.7rem"
                            >Settings</small
                          >
                          <div class="d-flex gap-3 mt-1">
                            <span
                              class="badge bg-light text-secondary border"
                              id="prof-comp-curr"
                              >INR</span
                            >
                            <span
                              class="badge bg-light text-secondary border"
                              id="prof-comp-tz"
                              >IST</span
                            >
                          </div>
                        </div>
                        <div class="col-md-6">
                          <small
                            class="text-uppercase text-muted fw-bold"
                            style="font-size: 0.7rem"
                            >Legal</small
                          >
                          <div
                            class="mt-1 font-monospace small text-dark"
                            id="prof-comp-tax"
                          >
                            -
                          </div>
                        </div>
                      </div>
                    </div>
                    <div
                      id="prof-company-empty"
                      class="text-center p-3 text-muted d-none"
                    >
                      No active organization.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal (Professional Light Theme) -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div
          class="modal-content border-0 shadow-lg"
          style="border-radius: 12px; overflow: hidden"
        >
          <div class="modal-header bg-white border-bottom py-3 px-4">
            <h5 class="modal-title fw-bold text-dark">
              <i class="bi bi-gear-fill me-2 text-primary"></i>Workspace
              Settings
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body bg-light p-4">
            <h6 class="fw-bold text-dark mb-3">Application Management</h6>
            <p class="text-muted small mb-4">
              Enable or disable applications for your organization. Changes
              affect all users.
            </p>

            <div id="settings-apps-list" class="vstack gap-3">
              <div class="text-center text-muted p-4">
                <div
                  class="spinner-border spinner-border-sm text-primary"
                ></div>
                <div class="mt-2 small">Loading applications...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Theme Toggle Logic
      const themeToggle = document.getElementById("theme-toggle");
      const body = document.body;

      // Load saved theme
      const savedTheme = localStorage.getItem("javelin-theme") || "dark";
      document.documentElement.setAttribute("data-theme", savedTheme);

      themeToggle.addEventListener("click", () => {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";

        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("javelin-theme", newTheme);
      });

      // Initialize particles
      function createParticles() {
        const container = document.getElementById("particles-container");
        const particleCount = 15;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.classList.add("particle");

          // Random size
          const size = Math.random() * 4 + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;

          // Random position
          particle.style.left = `${Math.random() * 100}%`;

          // Random animation delay and duration
          particle.style.animationDelay = `${Math.random() * 5}s`;
          particle.style.animationDuration = `${10 + Math.random() * 10}s`;

          container.appendChild(particle);
        }
      }
      createParticles();

      // Logout handling for portal
      document
        .getElementById("portal-logout")
        .addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("access_token");
          window.location.href = "login.html";
        });

      async function openProfileModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("profileModal")
        );
        modal.show();

        // Load Data
        try {
          const token = localStorage.getItem("access_token");
          if (!token) return;

          const res = await fetch("http://127.0.0.1:8000/oms/auth/me", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.ok) {
            const user = await res.json();
            // User Tab
            document.getElementById("prof-name").innerText =
              user.full_name || "N/A";
            document.getElementById("prof-email").innerText = user.email;
            document.getElementById("prof-id").innerText = "#" + user.id;

            // Company Tab
            if (user.company) {
              document
                .getElementById("prof-company-content")
                .classList.remove("d-none");
              document
                .getElementById("prof-company-empty")
                .classList.add("d-none");

              const c = user.company;
              document.getElementById("prof-comp-name").innerText = c.name;

              let addr = c.address || "";
              if (c.city) addr += `, ${c.city}`;
              if (c.state) addr += `, ${c.state}`;
              if (c.country) addr += `, ${c.country}`;
              if (c.zip_code) addr += ` - ${c.zip_code}`;
              document.getElementById("prof-comp-address").innerText =
                addr || "N/A";

              document.getElementById("prof-comp-email").innerHTML = c.email
                ? `<i class="bi bi-envelope me-2"></i>${c.email}`
                : "";
              document.getElementById("prof-comp-phone").innerHTML = c.phone
                ? `<i class="bi bi-telephone me-2"></i>${c.phone}`
                : "";
              document.getElementById("prof-comp-website").innerHTML = c.website
                ? `<i class="bi bi-globe me-2"></i><a href="${c.website}" target="_blank">${c.website}</a>`
                : "";

              document.getElementById("prof-comp-curr").innerText =
                c.currency || "INR";
              document.getElementById("prof-comp-tz").innerText =
                c.timezone || "UTC";
              document.getElementById("prof-comp-tax").innerText =
                c.tax_id || "N/A";
            } else {
              document
                .getElementById("prof-company-content")
                .classList.add("d-none");
              document
                .getElementById("prof-company-empty")
                .classList.remove("d-none");
            }
          }
        } catch (e) {
          console.error("Profile load failed", e);
        }
      }

      async function openSettingsModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("settingsModal")
        );
        modal.show();
        loadApps();
      }

      async function loadApps() {
        const list = document.getElementById("settings-apps-list");
        try {
          const token = localStorage.getItem("access_token");
          if (!token) return;

          const res = await fetch("http://127.0.0.1:8000/oms/settings/apps", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.ok) {
            const apps = await res.json();
            list.innerHTML = apps
              .map(
                (app) => `
                        <div class="card border-0 shadow-sm p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white fs-5" 
                                         style="width: 48px; height: 48px; background: linear-gradient(135deg, ${
                                           app.is_active_company
                                             ? "#10b981, #059669"
                                             : "#9ca3af, #6b7280"
                                         })">
                                        <i class="bi bi-grid-fill"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark mb-1 fs-6">${
                                          app.name
                                        }</div>
                                        <div class="text-muted small" style="max-width: 400px;">${
                                          app.description ||
                                          "No description available."
                                        }</div>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" style="width: 3rem; height: 1.5rem;" 
                                           id="app_switch_${app.id}" ${
                  app.is_active_company ? "checked" : ""
                }
                                           onchange="toggleApp(${
                                             app.id
                                           }, this.checked)">
                                </div>
                            </div>
                        </div>
                    `
              )
              .join("");
          }
        } catch (e) {
          console.error("Apps load failed", e);
          list.innerHTML = `<div class="text-danger">Failed to load apps.</div>`;
        }
      }

      async function toggleApp(appId, isActive) {
        try {
          const token = localStorage.getItem("access_token");
          await fetch(
            `http://127.0.0.1:8000/oms/settings/apps/${appId}/toggle?active=${isActive}`,
            {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          // Reload to refresh logic if needed, or visual update is enough
          loadApps(); // Refresh to ensure state
        } catch (e) {
          console.error(e);
        }
      }

      // Check Company Setup
      async function checkCompanySetup() {
        try {
          const token = localStorage.getItem("access_token");
          if (!token) return;

          // We need axios or fetch. Assuming fetch for now to avoid dependency if axios not loaded,
          // but checking head, axios is NOT loaded in index.html (only login.html/mango.html might have it).
          // Wait, index.html does NOT have axios. I should add it or use fetch.
          const response = await fetch("http://127.0.0.1:8000/oms/auth/me", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const user = await response.json();
            if (!user.company_id) {
              // Force setup
              const modalEl = document.getElementById("setupCompanyModal");
              document.getElementById("btn-cancel-setup").style.display =
                "none"; // Hide cancel
              // Keep it static
              const modal = new bootstrap.Modal(modalEl);
              modal.show();
            } else {
              localStorage.setItem("company_id", user.company_id);
              if (user.company) {
                // Update Portal Badge
                document.getElementById("portal-company-name").innerText =
                  user.company.name;
                document.getElementById("portal-company-badge").style.opacity =
                  "1";
              }
            }
          }
        } catch (e) {
          console.error("Auth check failed", e);
        }
      }

      async function openOrgManager() {
        const modal = new bootstrap.Modal(
          document.getElementById("orgManagerModal")
        );
        modal.show();
        loadMyCompanies();
      }

      async function loadMyCompanies() {
        const list = document.getElementById("org-list");
        try {
          const token = localStorage.getItem("access_token");
          const res = await fetch(
            "http://127.0.0.1:8000/oms/auth/my-companies",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (!res.ok) throw new Error(`Server returned ${res.status}`);

          const companies = await res.json();

          if (companies.length === 0) {
            list.innerHTML = `<div class="text-center text-muted p-3">No organizations found. Create one to get started.</div>`;
            return;
          }

          list.innerHTML = companies
            .map(
              (c) => `
                    <div class="card border-0 shadow-sm p-3 hover-elevate transition-all" style="background: white; border-radius: 8px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white fs-5" 
                                     style="width: 48px; height: 48px; background: linear-gradient(135deg, ${
                                       c.is_active
                                         ? "#3b82f6, #2563eb"
                                         : "#9ca3af, #6b7280"
                                     })">
                                    ${c.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark mb-0 fs-6">${
                                      c.name
                                    }</div>
                                    <div class="small text-muted d-flex align-items-center gap-2">
                                        <span class="badge bg-light text-secondary border">Role: ${
                                          c.role || "Member"
                                        }</span>
                                        <span class="text-secondary" style="font-size: 0.75rem;">ID: #${
                                          c.id
                                        }</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${
                              c.is_active
                                ? '<div class="badge bg-success-subtle text-success px-3 py-2 rounded-pill fw-bold"><i class="bi bi-check-circle-fill me-1"></i> Active</div>'
                                : `<button class="btn btn-outline-primary btn-sm px-3 rounded-pill fw-medium" onclick="switchCompany(${c.id})">Switch</button>`
                            }
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (e) {
          console.error(e);
          list.innerHTML = `<div class="alert alert-danger border-0 bg-danger-subtle text-danger text-center mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Failed to load organizations.
                    <br><small class="text-muted">Error: ${e.message}</small>
                </div>`;
        }
      }

      async function switchCompany(id) {
        try {
          const token = localStorage.getItem("access_token");
          const res = await fetch(
            `http://127.0.0.1:8000/oms/auth/switch-company/${id}`,
            {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          if (res.ok) {
            window.location.reload();
          }
        } catch (e) {
          alert("Switch failed");
        }
      }

      function showCreateCompanyModal() {
        // Hide manager, show setup
        bootstrap.Modal.getInstance(
          document.getElementById("orgManagerModal")
        ).hide();
        const modal = new bootstrap.Modal(
          document.getElementById("setupCompanyModal")
        );
        // Allow close
        document
          .getElementById("setupCompanyModal")
          .removeAttribute("data-bs-backdrop");
        document
          .getElementById("setupCompanyModal")
          .removeAttribute("data-bs-keyboard");
        document.getElementById("btn-cancel-setup").style.display =
          "inline-block"; // Show cancel
        modal.show();
      }

      // Handle Setup Form
      document
        .getElementById("companySetupForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.innerText;
          btn.innerText = "Processing...";
          btn.disabled = true;

          const data = {
            name: document.getElementById("cmp_name").value,
            email: document.getElementById("cmp_email").value,
            phone: document.getElementById("cmp_phone").value,
            website: document.getElementById("cmp_website").value,

            address: document.getElementById("cmp_address").value,
            city: document.getElementById("cmp_city").value,
            state: document.getElementById("cmp_state").value,
            zip_code: document.getElementById("cmp_zip").value,
            country: document.getElementById("cmp_country").value,

            tax_id: document.getElementById("cmp_tax").value,
            currency: document.getElementById("cmp_currency").value,
            timezone: document.getElementById("cmp_timezone").value,
          };

          try {
            const token = localStorage.getItem("access_token");
            const res = await fetch(
              "http://127.0.0.1:8000/oms/auth/setup-company",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(data),
              }
            );

            if (res.ok) {
              const company = await res.json();
              localStorage.setItem("company_id", company.id);
              // Close modal
              const modalEl = document.getElementById("setupCompanyModal");
              const modal = bootstrap.Modal.getInstance(modalEl);
              modal.hide();
              alert("Organization Setup Complete!");
              window.location.reload();
            } else {
              const err = await res.json();
              alert("Error: " + (err.detail || "Failed to create company"));
            }
          } catch (error) {
            console.error(error);
            alert("Network error");
          } finally {
            btn.innerText = originalText;
            btn.disabled = false;
          }
        });

      checkCompanySetup();
    </script>
  </body>
</html>
